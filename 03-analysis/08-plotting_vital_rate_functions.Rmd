---
title: "10-plotting_vital_rate_functions"
author: "Danny Foster"
date: "1/18/2022"
output: html_document
---

```{r}
# setup
library(here)
library(tidyverse)
library(posterior)
library(bayesplot)
library(cowplot)
library(ggspatial)
# load observed data
pila_fecd_training = readRDS(here::here('02-data', '02-for_analysis', 
                                        'pila_fecd_training.rds'))

pila_growth_training = readRDS(here::here('02-data', 
                                          '02-for_analysis',
                                          'pila_growth_training.rds'))

pila_mort_training = readRDS(here::here('02-data',
                                        '02-for_analysis',
                                        'pila_mort_training.rds'))

fit_s = readRDS(here::here('02-data',
                           '03-results',
                           'surv_fit.rds'))

fit_g = readRDS(here::here('02-data',
                           '03-results',
                           'growth_fit.rds'))

fit_f = readRDS(here::here('02-data',
                           '03-results',
                           'fecd_fit.rds'))

samples_s = readRDS(here::here('02-data',
                               '03-results',
                               'surv_post.rds'))

samples_g = readRDS(here::here('02-data',
                               '03-results',
                               'growth_post.rds'))

samples_f = readRDS(here::here('02-data',
                               '03-results',
                               'fecd_post.rds'))


betas_s = samples_s %>% select(contains('beta'))
betas_g = samples_g %>% select(contains('beta'))
betas_f = samples_f %>% select(contains('beta'))


```

# Posteriors vs Priors

## Survival

```{r}

beta_s_names =   
  data.frame(
      param = c('beta[1]', 'beta[2]', 'beta[3]', 'beta[4]', 'beta[5]',
                'beta[6]', 'beta[7]', 'beta[8]', 'beta[9]', 'beta[10]',
                'beta[11]', 'beta[12]', 'beta[13]', 'beta[14]',
                'beta[15]', 'beta[16]', 'beta[17]', 'beta[18]'),
      data_name = c('intercept', 'dbh_m.init', 
                                           'dbh_m2.init', 'fire', 
                                     'wpbr','ba_scaled', 'cwd_dep90_scaled', 
                                     'cwd_mean_scaled', 'dbh_fire', 'dbh2_fire',
                                     'dbh_wpbr','dbh2_wpbr',
                                     'dbh_ba', 'dbh2_ba', 'dbh_cwd90','dbh2_cwd90',
                                     'dbh_cwdmean', 'dbh2_cwdmean'),
      position = str_pad(1:18, width = 2, side = 'left', pad = '0'),
      pretty_name = 
          c('Intercept','DBH (m)','DBH^2 (m)', 'Fire','WPBR','Basal Area',
            'Drought','Site Dryness','DBH x Fire', 'DBH^2 x Fire', 
            'DBH x WPBR', 'DBH^2 x WPBR', 
            'DBH x BA', 'DBH^2 x BA', 'DBH x Drought', 'DBH^2 x Drought', 
            'DBH x Dryness', 'DBH^2 x Dryness'))

pretty_beta_s_labels = 
  beta_s_names$pretty_name
names(pretty_beta_s_labels) = beta_s_names$position
beta_s_priorvpost = 
  betas_s %>%
  rowid_to_column('iter') %>%
  pivot_longer(cols = c(-iter),
               names_to = 'param',
               values_to = 'value') %>%
  left_join(beta_s_names
    ) %>%
  ggplot(aes(x = value))+
  geom_density(lwd = 1)+
  geom_density(
    data = data.frame(prior = rnorm(n = 1000, mean = 0, sd = 5)),
    aes(x = prior),
    color = 'red'
  )+
  geom_vline(xintercept = 0, color = 'grey', lty = 2, lwd = 1)+
  theme_minimal()+
  facet_wrap(~position, scales = 'free',
             labeller = 
               labeller(position = pretty_beta_s_labels))+
  theme(axis.text.y = element_blank())

beta_s_priorvpost

ggsave(beta_s_priorvpost,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'beta_s_priorvpost.png'), 
       width = 6.5, height = 4, units = 'in')


sigmaPlot_s_priorvpost = 
  samples_s %>%
  select(sigma_plot) %>%
  ggplot(aes(x = sigma_plot))+
  geom_density(lwd = 1)+
  geom_density(data = 
                 data.frame(prior = truncnorm::rtruncnorm(n = 1000, a = 0, mean = 0, sd = 5)),
               aes(x = prior), color = 'red')+
  theme_minimal()+
  theme(axis.text.y = element_blank())

sigmaEco_s_priorvpost = 
  samples_s %>%
  select(sigma_ecosub) %>%
  ggplot(aes(x = sigma_ecosub))+
  geom_density(lwd = 1)+
  geom_density(data = 
                 data.frame(prior = truncnorm::rtruncnorm(n = 1000, a = 0, mean = 0, sd = 5)),
               aes(x = prior), color = 'red')+
  theme_minimal()+
  theme(axis.text.y = element_blank())

sigmas_s_priorvpost = 
  plot_grid(sigmaPlot_s_priorvpost, sigmaEco_s_priorvpost)

sigmas_s_priorvpost

ggsave(sigmas_s_priorvpost,
       filename = here::here('04-communication',
                  'figures',
                  'manuscript',
                  'sigmas_s_priorvpost.png'), width = 6.5, height = 4, units = 'in')


```

## Growth

```{r}
beta_g_names =   
  data.frame(
      param = c('beta[1]', 'beta[2]', 'beta[3]', 'beta[4]', 'beta[5]',
                'beta[6]', 'beta[7]', 'beta[8]', 'beta[9]', 'beta[10]',
                'beta[11]', 'beta[12]'),
      data_name = c('intercept', 'dbh_m.init', 'fire', 
              'wpbr','ba_scaled', 'cwd_dep90_scaled', 
              'cwd_mean_scaled', 'dbh_fire', 
              'dbh_wpbr', 'dbh_ba', 'dbh_cwd90', 'dbh_cwdmean'),
      position = str_pad(1:12, width = 2, side = 'left', pad = '0'),
      pretty_name = 
          c('Intercept','DBH (m)','Fire','WPBR','Basal Area',
            'Drought','Site Dryness','DBH x Fire','DBH x WPBR',
            'DBH x BA','DBH x Drought','DBH x Dryness'))

pretty_beta_g_labels = 
  beta_g_names$pretty_name
names(pretty_beta_g_labels) = beta_g_names$position

beta_g_priorvpost = 
  betas_g %>%
  rowid_to_column('iter') %>%
  pivot_longer(cols = c(-iter),
               names_to = 'param',
               values_to = 'value') %>%
  left_join(beta_g_names
    ) %>%
  ggplot(aes(x = value))+
  geom_density(lwd = 1)+
  geom_density(
    data = data.frame(prior = rnorm(n = 1000, mean = 0, sd = 5)),
    aes(x = prior),
    color = 'red'
  )+
  geom_vline(xintercept = 0, color = 'grey', lty = 2, lwd = 1)+
  theme_minimal()+
  facet_wrap(~position, scales = 'free',
             labeller = 
               labeller(position = pretty_beta_g_labels))+
  theme(axis.text.y = element_blank())

beta_g_priorvpost

ggsave(beta_g_priorvpost,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'beta_g_priorvpost.png'), width = 6.5, height = 4, units = 'in')

sigmaPlot_g_priorvpost = 
  samples_g %>%
  select(sigma_plot) %>%
  ggplot(aes(x = sigma_plot))+
  geom_density(lwd = 1)+
  geom_density(data = 
                 data.frame(prior = truncnorm::rtruncnorm(n = 1000, a = 0, mean = 0, sd = 5)),
               aes(x = prior), color = 'red')+
  theme_minimal()+
  theme(axis.text.y = element_blank())



sigmaEco_g_priorvpost = 
  samples_g %>%
  select(sigma_ecosub) %>%
  ggplot(aes(x = sigma_ecosub))+
  geom_density(lwd = 1)+
  geom_density(data = 
                 data.frame(prior = truncnorm::rtruncnorm(n = 1000, a = 0, mean = 0, sd = 5)),
               aes(x = prior), color = 'red')+
  theme_minimal()+
  theme(axis.text.y = element_blank())

sigmaEpsilon_g_priorvpost = 
  samples_g %>%
  select(sigma_epsilon) %>%
  ggplot(aes(x = sigma_epsilon))+
  geom_density(lwd = 1)+
  geom_density(data = 
                 data.frame(prior = truncnorm::rtruncnorm(n = 1000, a = 0, mean = 0, sd = 5)),
               aes(x = prior), color = 'red')+
  theme_minimal()+
  theme(axis.text.y = element_blank())

sigmas_g_priorvpost = 
  plot_grid(sigmaPlot_g_priorvpost,
            sigmaEco_g_priorvpost,
            sigmaEpsilon_g_priorvpost)

sigmas_g_priorvpost

ggsave(sigmas_g_priorvpost,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'sigmas_g_priorvpost.png'), width = 6.5, height = 4, units = 'in')

```

## Fecundity

```{r}
beta_f_names =   
  data.frame(
      param = c('beta[1]'),
      data_name = c('intercept'),
      position = str_pad(1:1, width = 2, side = 'left', pad = '0'),
      pretty_name = 
          c('Intercept'))

pretty_beta_f_labels = 
  beta_f_names$pretty_name
names(pretty_beta_f_labels) = beta_f_names$position

beta_f_priorvpost = 
  betas_f %>%
  rowid_to_column('iter') %>%
  pivot_longer(cols = c(-iter),
               names_to = 'param',
               values_to = 'value') %>%
  left_join(beta_f_names
    ) %>%
  ggplot(aes(x = value))+
  geom_density(lwd = 1)+
  geom_density(
    data = data.frame(prior = rnorm(n = 1000, mean = 0, sd = 5)),
    aes(x = prior),
    color = 'red'
  )+
  geom_vline(xintercept = 0, color = 'grey', lty = 2, lwd = 1)+
  theme_minimal()+
  facet_wrap(~position, scales = 'free',
             labeller = 
               labeller(position = pretty_beta_f_labels))+
  theme(axis.text.y = element_blank())

beta_f_priorvpost

ggsave(beta_f_priorvpost,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'beta_f_priorvpost.png'), width = 6.5, height = 4, units = 'in')

half_cauchy_samples = 
  sapply(X = 1:1000,
         FUN = function(i){
           sample = 0
           while(sample<=0){
            sample = rcauchy(n = 1, location = 0, scale = 5)
           }
           return(sample)
         })

kappa_r_priorvpost = 
  samples_f %>%
  select(kappa) %>%
  ggplot(aes(x = kappa))+
  geom_density(lwd = 1)+
  theme_minimal()+
  geom_density(
    data = data.frame(prior = half_cauchy_samples),
    aes(x = prior), 
    color = 'red'
  )+
  theme(axis.text.y = element_blank())+
  scale_x_continuous(limits = c(0, 10))

kappa_r_priorvpost

ggsave(kappa_r_priorvpost,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'kappa_r_priorvpost.png'), 
       width = 6.5, height = 4, units = 'in')

```


# Plotting parameters

## Survival

```{r}
summary_s = 
  fit_s$summary(variables = c('beta', 'sigma_plot', 'sigma_ecosub')) %>%
  left_join(beta_s_names %>%
              bind_rows(
                data.frame(param = c('sigma_plot', 'sigma_ecosub'),
                       position = c('19', '20'),
                       pretty_name = c('SD Plots', 'SD Ecoregions'))
              ),
            by = c('variable' = 'param')) %>%
  select(Position = position,
         Parameter = pretty_name, 
         Mean = mean, Median = median, StDev = sd, 
         q5, q95, rhat, ess_bulk, ess_tail) %>%
  arrange(Position) %>%
  select(-Position)

summary_s

write.csv(summary_s,
          here::here('04-communication',
                     'tables',
                     'summary_s.csv'),
          row.names = FALSE)

```



## Growth


```{r}

summary_g = 
  fit_g$summary(variables = c('beta', 'sigma_plot', 'sigma_ecosub',
                                 'sigma_epsilon')) %>%
  left_join(beta_g_names %>%
              bind_rows(
                data.frame(param = c('sigma_plot', 'sigma_ecosub',
                                     'sigma_epsilon'),
                       position = c('13', '14', '15'),
                       pretty_name = c('SD Plots', 'SD Ecoregions', 'SD Residual'))
              ),
            by = c('variable' = 'param')) %>%
  select(Position = position,
         Parameter = pretty_name, 
         Mean = mean, Median = median, StDev = sd, 
         q5, q95, rhat, ess_bulk, ess_tail) %>%
  arrange(Position) %>%
  select(-Position)

summary_g

write.csv(summary_g,
          here::here('04-communication',
                     'tables',
                     'summary_g.csv'),
          row.names = FALSE)

```

## Fecundity

```{r}



summary_f = 
  fit_f$summary(variables = c('beta', 'kappa')) %>%
  left_join(beta_f_names %>%
              bind_rows(
                data.frame(param = c('kappa'),
                       position = c('2'),
                       pretty_name = c('NB Dispersion'))
              ),
            by = c('variable' = 'param')) %>%
  select(Position = position,
         Parameter = pretty_name, 
         Mean = mean, Median = median, StDev = sd, 
         q5, q95, rhat, ess_bulk, ess_tail) %>%
  arrange(Position) %>%
  select(-Position)

summary_f

write.csv(summary_f,
          here::here('04-communication',
                     'tables',
                     'summary_f.csv'),
          row.names = FALSE)

```

# Fixed Effects Counterfactuals

## Survival

```{r}

predict_survival_fixeff = 
  function(dataset){
    do.call('rbind',
            lapply(X = 1:4000,
                   FUN = function(i){
                     
                     beta_i = as.numeric(betas_s[i,])
                     
                     X = dataset[,c('intercept', 'dbh_m.init', 'dbh2_m.init',
                                    'fire', 
                                    'wpbr', 'ba_scaled', 
                                    'cwd_dep90_scaled', 'cwd_mean_scaled', 
                                    'dbh_fire', 'dbh2_fire', 'dbh_wpbr',
                                    'dbh2_wpbr',
                                    'dbh_ba', 'dbh2_ba', 'dbh_cwd90', 'dbh2_cwd90', 
                                    'dbh_cwdmean', 'dbh2_cwdmean')]
                     
                     predictions = X
                     predictions$logitp = 
                       as.numeric(as.matrix(X) %*% beta_i)
                     predictions$p = boot::inv.logit(predictions$logitp)
                     return(predictions)
                     
                   }))
    
  }

# first, "main effects" (other than the focal variable, disturbances held at false 
# and continuous variables held at 0 (other than size, they are scaled) 

## size main effect (no disturbances, continuous variables held at 0, which is 
## the subplot-level mean (so like the average subplot))
size_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  scale_y_continuous(limits = c(0, 1))+
  theme_minimal()+
  labs(y = 'Survival',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X fire
fire_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = c(0,1),
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(fire)))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975, fill = as.factor(fire)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75, fill = as.factor(fire)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  theme_minimal()+
  labs(y = 'Survival',
       fill = 'Fire',
       color = 'Fire',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X wpbr
wpbr_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = c(0,1),
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(wpbr)))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975, fill = as.factor(wpbr)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75, fill = as.factor(wpbr)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  theme_minimal()+
  labs(y = 'Survival',
       fill = 'WPBR',
       color = 'WPBR',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X Basal area
ba_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = c(-1,1),
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(ba_scaled)))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975, fill = as.factor(ba_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75, fill = as.factor(ba_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'Survival',
       fill = 'Basal Area',
       color = 'Basal Area',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X drought
drought_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = c(-1,1),
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(cwd_dep90_scaled)))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975, fill = as.factor(cwd_dep90_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75, fill = as.factor(cwd_dep90_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'Survival',
       fill = 'Drought',
       color = 'Drought',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X dryness
dryness_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = c(-1,1)) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(cwd_mean_scaled)))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975, fill = as.factor(cwd_mean_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75, fill = as.factor(cwd_mean_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'Survival',
       fill = 'Site Dryness',
       color = 'Site Dryness',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')


fixeff_s = 
  plot_grid(size_fixeff_s, fire_fixeff_s, wpbr_fixeff_s,
          ba_fixeff_s, drought_fixeff_s, dryness_fixeff_s,
          nrow = 3, ncol = 2)


fixeff_s_ppt = 
  plot_grid(
    size_fixeff_s+theme(text = element_text(size = 14)),
    fire_fixeff_s+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    wpbr_fixeff_s+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    ba_fixeff_s+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    drought_fixeff_s+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    dryness_fixeff_s+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    nrow = 2, ncol = 3
  )

fixeff_s_ppt

ggsave(fixeff_s_ppt,
       filename = here::here('04-communication',
                             'figures',
                             'powerpoint',
                             'fixeff_s.png'),
       height = 5, width = 11)

ggsave(fixeff_s,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'fixeff_s.png'), 
       height = 8, width = 6.5, units = 'in')
```

## Growth

```{r}

predict_grow_fixeff = 
  function(dataset){
    do.call('rbind',
            lapply(X = 1:4000,
                   FUN = function(i){
                     
                     beta_i = as.numeric(betas_g[i,])
                     
                     X = dataset[,c('intercept', 'dbh_m.init', 'dbh2_m.init',
                                    'fire', 
                                    'wpbr', 'ba_scaled', 
                                    'cwd_dep90_scaled', 'cwd_mean_scaled', 
                                    'dbh_fire', 'dbh2_fire', 'dbh_wpbr',
                                    'dbh2_wpbr',
                                    'dbh_ba', 'dbh2_ba', 'dbh_cwd90', 'dbh2_cwd90', 
                                    'dbh_cwdmean', 'dbh2_cwdmean')]
                     
                     predictions = X
                     predictions$size1 = 
                       as.numeric(as.matrix(X) %*% beta_i)
                     predictions$grow = 
                       predictions$size1-predictions$dbh_m.init
                     return(predictions)
                     
                   }))
    
  }
# first, "main effects" (other than the focal variable, disturbances held at false 
# and continuous variables held at 0 (other than size, they are scaled) 

## size main effect (no disturbances, continuous variables held at 0, which is 
## the subplot-level mean (so like the average subplot))
size_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_continuous(limits = c(-0.01, 0.07))

# size X fire
fire_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = c(0,1),
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(fire)))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975, fill = as.factor(fire)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75, fill = as.factor(fire)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       fill = 'Fire',
       color = 'Fire',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_continuous(limits = c(-0.01, 0.07))

# size X wpbr
wpbr_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = c(0,1),
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(wpbr)))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975, fill = as.factor(wpbr)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75, fill = as.factor(wpbr)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       fill = 'WPBR',
       color = 'WPBR',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_continuous(limits = c(-0.01, 0.07))

# size X Basal area
ba_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = c(-1,1),
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(ba_scaled)))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975, fill = as.factor(ba_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75, fill = as.factor(ba_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       fill = 'Basal Area',
       color = 'Basal Area',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_continuous(limits = c(-0.01, 0.07))

# size X drought
drought_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = c(-1,1),
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(cwd_dep90_scaled)))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975, fill = as.factor(cwd_dep90_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75, fill = as.factor(cwd_dep90_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       fill = 'Drought',
       color = 'Drought',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_continuous(limits = c(-0.01, 0.07))

# size X dryness
dryness_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = c(-1,1)) %>%
  mutate(dbh2_m.init = dbh_m.init**2,
         dbh_fire = dbh_m.init*fire,
         dbh2_fire = dbh2_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh2_wpbr = dbh2_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh2_ba = dbh2_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh2_cwd90 = dbh2_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled,
         dbh2_cwdmean = dbh2_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(cwd_mean_scaled)))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975, fill = as.factor(cwd_mean_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75, fill = as.factor(cwd_mean_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       fill = 'Site Dryness',
       color = 'Site Dryness',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_continuous(limits = c(-0.01, 0.07))

fixeff_g = 
  plot_grid(size_fixeff_g, fire_fixeff_g, wpbr_fixeff_g, ba_fixeff_g, 
            drought_fixeff_g, dryness_fixeff_g, 
            ncol = 2, nrow = 3)

fixeff_g

ggsave(fixeff_g,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'fixeff_g.png'), 
       height =8, width = 6.5, units = 'in')

fixeff_g_ppt = 
  plot_grid(
    size_fixeff_g+theme(text = element_text(size = 14)),
    fire_fixeff_g+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    wpbr_fixeff_g+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    ba_fixeff_g+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    drought_fixeff_g+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    dryness_fixeff_g+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    nrow = 2, ncol = 3
  )

fixeff_g_ppt

ggsave(fixeff_g_ppt,
       filename = here::here('04-communication',
                             'figures',
                             'powerpoint',
                             'fixeff_g.png'),
       height = 5, width = 11)
```

## Fecundity



# Random Effects

```{r}
# get ecoregion polygons for mapping random effects
# (ecological subsection polygons downloaded from 
# https://data.fs.usda.gov/geodata/edw/datasets.php?dsetCategory=geoscientificinformation
# on Jan 9, 2022)
library(sf)

ecosub.sf = 
  st_read(here::here('02-data',
                     '00-source',
                     'usfs',
                     'S_USA.EcomapSubsections',
                     'S_USA.EcomapSubsections.shp')) %>%
  st_make_valid() %>%
  select(MAP_UNIT_S, MAP_UNIT_N) %>%
  left_join(
    readRDS(here::here('02-data',
                       '02-for_analysis',
                       'union_ecosubs.rds')),
    by = c('MAP_UNIT_S' = 'ecosubcd')
  )


# get plot locations for mapping random effects
plots.sf = 
    readRDS(here::here('02-data',
                       '01-preprocessed',
                       'plot_data.rds')) %>%
      group_by(plot_id, lat, lon) %>%
      summarise() %>%
      ungroup()  %>%
  st_as_sf(coords = c('lon', 'lat'),
           crs = 4269) %>%
  left_join(readRDS(here::here('02-data',
                               '02-for_analysis',
                               'union_plots.rds')))



```


## Survival

```{r}
ecoEffect_s.med = 
  samples_s %>%
  select(contains('effect_ecosub')) %>%
  summarise_all(median) %>%
  as.numeric()

ecosub.sf$ecoEffect_s.med = 
  ecoEffect_s.med[ecosub.sf$ecosub.i]

ecoEffect_map_s = 
  ggplot(data = ecosub.sf,
       aes(fill = ecoEffect_s.med))+
  geom_sf(data = 
            USAboundaries::us_states(),
          fill = NA)+
  geom_sf(color = NA)+
  theme_minimal()+
  scale_fill_viridis_c(na.value = 'transparent')+
  labs(fill = 'Ecoregion effect\n(Survival)')+
  theme(legend.position = 'bottom')+
  coord_sf(xlim = c(390000, 1100000), ylim = c(3740000, 5020000),
           crs = "EPSG:26910")+
  annotation_scale()

ecoEffect_map_s

plotEffect_s.med = 
  samples_s %>%
  select(contains('effect_plot')) %>%
  summarise_all(median) %>%
  as.numeric()

plots.sf$plotEffect_s.med = 
  plotEffect_s.med[plots.sf$plot_id.i]

ggplot(data = plots.sf,
       aes(color = plotEffect_s.med))+
  geom_sf(size = 1, alpha = 0.5)+
  theme_minimal()+
  scale_color_viridis_c()

```


## Growth


```{r}
ecoEffect_g.med = 
  samples_g %>%
  select(contains('effect_ecosub')) %>%
  summarise_all(median) %>%
  as.numeric()

ecosub.sf$ecoEffect_g.med = 
  ecoEffect_g.med[ecosub.sf$ecosub.i]

ecoEffect_map_g = 
  ggplot(data = ecosub.sf,
       aes(fill = ecoEffect_g.med))+
  geom_sf(data = 
            USAboundaries::us_states(),
          fill = NA)+
  geom_sf(color = NA)+
  theme_minimal()+
  scale_fill_viridis_c(na.value = 'transparent')+
  labs(fill = 'Ecoregion effect\n(Growth)')+
  theme(legend.position = 'bottom')+
  coord_sf(xlim = c(390000, 1100000), ylim = c(3740000, 5020000),
           crs = "EPSG:26910")+
  annotation_scale()

ecoEffect_map_g

plotEffect_g.med = 
  samples_g %>%
  select(contains('effect_plot')) %>%
  summarise_all(median) %>%
  as.numeric()

plots.sf$plotEffect_g.med = 
  plotEffect_g.med[plots.sf$plot_id.i]

ggplot(data = plots.sf,
       aes(color = plotEffect_g.med))+
  geom_sf(size = 1, alpha = 0.5)+
  theme_minimal()+
  scale_color_viridis_c()

```

Ecoregion-level effects don't look independent here; there's a clear pattern 
of higher growth in the SE part of the range and lower growth in the NW.

## Fecundity



## Ecoregion effect map for all three

```{r}
ecoEffect_map = 
  plot_grid(ecoEffect_map_s, ecoEffect_map_g,
            nrow = 1)

ecoEffect_map

ggsave(ecoEffect_map,
       filename = here::here('04-communication',
                  'figures',
                  'manuscript',
                  'ecoEffect_map.png'),
       height = 6.5, width = 6.5, units = 'in')

```


# Data slide

A map with all the data sources on it:

```{r}

overview_map = 
  ggplot(data = 
         spData::world %>%
         filter(continent=='North America'))+
  geom_sf(fill = NA, lwd = 1)+
  geom_rect(xmin = 390000, xmax = 1100000, ymin = 3740000, ymax = 5020000,
            fill = NA, color = 'red', lwd = 2)+
  coord_sf(crs = "EPSG:26910",
           xlim = c(200000, 5000000), ylim = c(1000000, 8000000))+
  theme_minimal()+
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        panel.grid = element_blank(),
        plot.background = element_rect(fill = 'white'),
        plot.margin = unit(c(0, 0, 0, 0), 'cm'))

overview_map

range_map = 
  ggplot()+
  geom_sf(data = 
            spData::us_states,
          fill = NA, lwd = 1)+
  #geom_sf(color = 'blue', fill = NA)+
  geom_sf(data = plots.sf, aes(color = 'red'), size = 1, alpha = 0.5)+
  theme_minimal()+
  coord_sf(xlim = c(390000, 1100000), ylim = c(3740000, 5020000),
           crs = "EPSG:26910")+
  annotation_scale()+
  scale_color_manual(name = '', 
                     values = c('red' = 'red'), 
                     labels = c('FIA plots'))+
  theme(legend.position = 'bottom',
        axis.text.x = element_text(angle = 45))

range_map


range_map_ppt = 
  ggplot()+
  geom_sf(data = 
            spData::us_states,
          fill = NA, lwd = 1)+
  #geom_sf(color = 'blue', fill = NA)+
  geom_sf(data = plots.sf, aes(color = 'red'), size = 1, alpha = 0.5)+
  theme_minimal()+
  coord_sf(xlim = c(390000, 1100000), ylim = c(3740000, 5020000),
           crs = "EPSG:26910")+
  annotation_scale()+
  scale_color_manual(name = '', 
                     values = c('red' = 'red'), 
                     labels = c('FIA plots'))+
  theme(legend.position = 'bottom',
        text = element_text(size = 18),
        axis.text.x = element_blank(),
        axis.text.y = element_blank())

range_map_ppt

data_map = 
  ggdraw()+
  draw_plot(range_map)+
  draw_plot(overview_map,
            x = 0.58, y = 0.57, width = 0.3, height = 0.3)

data_map_ppt = 
  ggdraw()+
  draw_plot(range_map_ppt)+
  draw_plot(overview_map,
            x = 0.48, y = 0.6, width = 0.3, height = 0.3)

data_map

ggsave(data_map,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'data_map.png'),
       height = 6, width = 4, units = 'in')



ggsave(data_map_ppt,
       filename = here::here('04-communication',
                             'figures',
                             'powerpoint',
                             'data_map.png'),
       height = 6, width = 4, units = 'in')

```

