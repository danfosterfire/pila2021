---
title: "10-plotting_vital_rate_functions"
author: "Danny Foster"
date: "1/18/2022"
output: html_document
---

```{r}
# setup
library(here)
library(tidyverse)
library(posterior)
library(bayesplot)
library(cowplot)
library(ggspatial)
# load observed data
pila_data = readRDS(here::here('02-data', '02-for_analysis', 'pila_training.rds'))

# load mcmc results
pila_fit = readRDS(here::here('02-data', '03-results', 'real_fits', 'pila.rds'))

samples = as_draws_df(pila_fit$draws())

betas_s = samples %>% select(contains('beta_s'))
betas_g = samples %>% select(contains('beta_g'))
betas_f = samples %>% select(contains('beta_f'))


```

# Posteriors vs Priors

## Survival

```{r}

beta_s_names =   
  data.frame(
      param = c('beta_s[1]', 'beta_s[2]', 'beta_s[3]', 'beta_s[4]', 'beta_s[5]',
                'beta_s[6]', 'beta_s[7]', 'beta_s[8]', 'beta_s[9]', 'beta_s[10]',
                'beta_s[11]', 'beta_s[12]'),
      data_name = c('intercept', 'dbh_m.init', 'fire', 
              'wpbr','ba_scaled', 'cwd_dep90_scaled', 
              'cwd_mean_scaled', 'dbh_fire', 
              'dbh_wpbr', 'dbh_ba', 'dbh_cwd90', 'dbh_cwdmean'),
      position = str_pad(1:12, width = 2, side = 'left', pad = '0'),
      pretty_name = 
          c('Intercept','DBH (m)','Fire','WPBR','Basal Area',
            'Drought','Site Dryness','DBH x Fire','DBH x WPBR',
            'DBH x BA','DBH x Drought','DBH x Dryness'))

pretty_beta_s_labels = 
  beta_s_names$pretty_name
names(pretty_beta_s_labels) = beta_s_names$position
beta_s_priorvpost = 
  betas_s %>%
  rowid_to_column('iter') %>%
  pivot_longer(cols = c(-iter),
               names_to = 'param',
               values_to = 'value') %>%
  left_join(beta_s_names
    ) %>%
  ggplot(aes(x = value))+
  geom_density(lwd = 1)+
  geom_density(
    data = data.frame(prior = rnorm(n = 1000, mean = 0, sd = 5)),
    aes(x = prior),
    color = 'red'
  )+
  geom_vline(xintercept = 0, color = 'grey', lty = 2, lwd = 1)+
  theme_minimal()+
  facet_wrap(~position, scales = 'free',
             labeller = 
               labeller(position = pretty_beta_s_labels))

beta_s_priorvpost

ggsave(beta_s_priorvpost,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'beta_s_priorvpost.png'), 
       height = 6.5, width = 4, units = 'in')


sigmaPlot_s_priorvpost = 
  samples %>%
  select(sigmaPlot_s) %>%
  ggplot(aes(x = sigmaPlot_s))+
  geom_density(lwd = 1)+
  geom_density(data = 
                 data.frame(prior = truncnorm::rtruncnorm(n = 1000, a = 0, mean = 0, sd = 5)),
               aes(x = prior), color = 'red')+
  theme_minimal()

sigmaEco_s_priorvpost = 
  samples %>%
  select(sigmaEco_s) %>%
  ggplot(aes(x = sigmaEco_s))+
  geom_density(lwd = 1)+
  geom_density(data = 
                 data.frame(prior = truncnorm::rtruncnorm(n = 1000, a = 0, mean = 0, sd = 5)),
               aes(x = prior), color = 'red')+
  theme_minimal()

sigmas_s_priorvpost = 
  plot_grid(sigmaPlot_s_priorvpost, sigmaEco_s_priorvpost)

sigmas_s_priorvpost

ggsave(sigmas_s_priorvpost,
       filename = here::here('04-communication',
                  'figures',
                  'manuscript',
                  'sigmas_s_priorvpost.png'), height = 6.5, width = 4, units = 'in')


```

## Growth

```{r}
beta_g_names =   
  data.frame(
      param = c('beta_g[1]', 'beta_g[2]', 'beta_g[3]', 'beta_g[4]', 'beta_g[5]',
                'beta_g[6]', 'beta_g[7]', 'beta_g[8]', 'beta_g[9]', 'beta_g[10]',
                'beta_g[11]', 'beta_g[12]'),
      data_name = c('intercept', 'dbh_m.init', 'fire', 
              'wpbr','ba_scaled', 'cwd_dep90_scaled', 
              'cwd_mean_scaled', 'dbh_fire', 
              'dbh_wpbr', 'dbh_ba', 'dbh_cwd90', 'dbh_cwdmean'),
      position = str_pad(1:12, width = 2, side = 'left', pad = '0'),
      pretty_name = 
          c('Intercept','DBH (m)','Fire','WPBR','Basal Area',
            'Drought','Site Dryness','DBH x Fire','DBH x WPBR',
            'DBH x BA','DBH x Drought','DBH x Dryness'))

pretty_beta_g_labels = 
  beta_g_names$pretty_name
names(pretty_beta_g_labels) = beta_g_names$position

beta_g_priorvpost = 
  betas_g %>%
  rowid_to_column('iter') %>%
  pivot_longer(cols = c(-iter),
               names_to = 'param',
               values_to = 'value') %>%
  left_join(beta_g_names
    ) %>%
  ggplot(aes(x = value))+
  geom_density(lwd = 1)+
  geom_density(
    data = data.frame(prior = rnorm(n = 1000, mean = 0, sd = 5)),
    aes(x = prior),
    color = 'red'
  )+
  geom_vline(xintercept = 0, color = 'grey', lty = 2, lwd = 1)+
  theme_minimal()+
  facet_wrap(~position, scales = 'free',
             labeller = 
               labeller(position = pretty_beta_g_labels))

beta_g_priorvpost

ggsave(beta_g_priorvpost,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'beta_g_priorvpost.png'), height = 6.5, width = 4, units = 'in')

sigmaPlot_g_priorvpost = 
  samples %>%
  select(sigmaPlot_g) %>%
  ggplot(aes(x = sigmaPlot_g))+
  geom_density(lwd = 1)+
  geom_density(data = 
                 data.frame(prior = truncnorm::rtruncnorm(n = 1000, a = 0, mean = 0, sd = 5)),
               aes(x = prior), color = 'red')+
  theme_minimal()



sigmaEco_g_priorvpost = 
  samples %>%
  select(sigmaEco_g) %>%
  ggplot(aes(x = sigmaEco_g))+
  geom_density(lwd = 1)+
  geom_density(data = 
                 data.frame(prior = truncnorm::rtruncnorm(n = 1000, a = 0, mean = 0, sd = 5)),
               aes(x = prior), color = 'red')+
  theme_minimal()

sigmaEpsilon_g_priorvpost = 
  samples %>%
  select(sigmaEpsilon_g) %>%
  ggplot(aes(x = sigmaEpsilon_g))+
  geom_density(lwd = 1)+
  geom_density(data = 
                 data.frame(prior = truncnorm::rtruncnorm(n = 1000, a = 0, mean = 0, sd = 5)),
               aes(x = prior), color = 'red')+
  theme_minimal()

sigmas_g_priorvpost = 
  plot_grid(sigmaPlot_g_priorvpost,
            sigmaEco_g_priorvpost,
            sigmaEpsilon_g_priorvpost)

sigmas_g_priorvpost

ggsave(sigmas_g_priorvpost,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'sigmas_g_priorvpost.png'), height = 6.5, width = 4, units = 'in')

```

## Fecundity

```{r}
beta_f_names =   
  data.frame(
      param = c('beta_f[1]', 'beta_f[2]', 'beta_f[3]', 'beta_f[4]', 'beta_f[5]',
                'beta_f[6]', 'beta_f[7]', 'beta_f[8]', 'beta_f[9]', 'beta_f[10]',
                'beta_f[11]', 'beta_f[12]'),
      data_name = c('intercept', 'dbh_m.init', 'fire', 
              'wpbr','ba_scaled', 'cwd_dep90_scaled', 
              'cwd_mean_scaled', 'dbh_fire', 
              'dbh_wpbr', 'dbh_ba', 'dbh_cwd90', 'dbh_cwdmean'),
      position = str_pad(1:12, width = 2, side = 'left', pad = '0'),
      pretty_name = 
          c('Intercept','DBH (m)','Fire','WPBR','Basal Area',
            'Drought','Site Dryness','DBH x Fire','DBH x WPBR',
            'DBH x BA','DBH x Drought','DBH x Dryness'))

pretty_beta_f_labels = 
  beta_f_names$pretty_name
names(pretty_beta_f_labels) = beta_f_names$position

beta_f_priorvpost = 
  betas_f %>%
  rowid_to_column('iter') %>%
  pivot_longer(cols = c(-iter),
               names_to = 'param',
               values_to = 'value') %>%
  left_join(beta_f_names
    ) %>%
  ggplot(aes(x = value))+
  geom_density(lwd = 1)+
  geom_density(
    data = data.frame(prior = rnorm(n = 1000, mean = 0, sd = 5)),
    aes(x = prior),
    color = 'red'
  )+
  geom_vline(xintercept = 0, color = 'grey', lty = 2, lwd = 1)+
  theme_minimal()+
  facet_wrap(~position, scales = 'free',
             labeller = 
               labeller(position = pretty_beta_f_labels))

beta_f_priorvpost

ggsave(beta_f_priorvpost,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'beta_f_priorvpost.png'), height = 6.5, width = 4, units = 'in')

half_cauchy_samples = 
  sapply(X = 1:1000,
         FUN = function(i){
           sample = 0
           while(sample<=0){
            sample = rcauchy(n = 1, location = 0, scale = 5)
           }
           return(sample)
         })

kappa_r_priorvpost = 
  samples %>%
  select(kappa_r) %>%
  ggplot(aes(x = kappa_r))+
  geom_density(lwd = 1)+
  theme_minimal()+
  geom_density(
    data = data.frame(prior = half_cauchy_samples),
    aes(x = prior), 
    color = 'red'
  )

kappa_r_priorvpost

ggsave(kappa_r_priorvpost,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'kappa_r_priorvpost.png'), 
       height = 6.5, width = 4, units = 'in')

```


# Plotting parameters

## Survival

```{r}
mcmc_intervals(samples,
               pars = c('beta_s[1]',
                        'beta_s[2]',
                        'beta_s[3]',
                        'beta_s[4]',
                        'beta_s[5]',
                        'beta_s[6]',
                        'beta_s[7]',
                        'beta_s[8]',
                        'beta_s[9]',
                        'beta_s[10]',
                        'beta_s[11]',
                        'beta_s[12]',
                        'sigmaPlot_s',
                        'sigmaEco_s'))

help(summary)

summary_s = 
  pila_fit$summary(variables = c('beta_s', 'sigmaPlot_s', 'sigmaEco_s')) %>%
  left_join(beta_s_names %>%
              bind_rows(
                data.frame(param = c('sigmaPlot_s', 'sigmaEco_s'),
                       position = c('13', '14'),
                       pretty_name = c('SD Plots', 'SD Ecoregions'))
              ),
            by = c('variable' = 'param')) %>%
  select(Position = position,
         Parameter = pretty_name, 
         Mean = mean, Median = median, StDev = sd, 
         q5, q95, rhat, ess_bulk, ess_tail) %>%
  arrange(Position) %>%
  select(-Position)

summary_s

write.csv(summary_s,
          here::here('04-communication',
                     'tables',
                     'summary_s.csv'),
          row.names = FALSE)

pretty_params_s = 
  samples %>%
  select(sigmaPlot_s, sigmaEco_s, contains('beta_s')) %>%
  pivot_longer(cols = everything(), names_to = 'param', values_to = 'value') %>%
  left_join(beta_s_names %>%
              bind_rows(
                data.frame(param = c('sigmaPlot_s', 'sigmaEco_s'),
                       position = c('13', '14'),
                       pretty_name = c('SD Plots', 'SD Ecoregions'))
              ))

paramvalues_s = 
  ggplot(
  data = 
    pretty_params_s %>%
    group_by(param, position, pretty_name) %>%
    summarise(value.05 = quantile(value, probs = 0.05),
              value.25 = quantile(value, probs = 0.25),
              value.50 = quantile(value, probs = 0.5),
              value.75 = quantile(value, probs = 0.75),
              value.95 = quantile(value, probs = 0.95)) %>%
    ungroup() %>%
    mutate(pretty_name = 
             factor(pretty_name, 
                    levels = c('Intercept', 'DBH (m)', 'Fire', 'WPBR', 'Basal Area',
                               'Drought', 'Site Dryness', 'DBH x Fire', 
                               'DBH x WPBR', 'DBH x BA', 'DBH x Drought',
                               'DBH x Dryness', 'SD Plots', 'SD Ecoregions'))))+
  geom_vline(xintercept = 0, lty = 2, color = 'grey', lwd = 1)+
  geom_segment(aes(y = pretty_name, yend = pretty_name, x = value.05, xend = value.95),
               color = 'deepskyblue1', lwd = 1)+
  geom_segment(aes(y = pretty_name, yend = pretty_name, x = value.25, xend = value.75),
               color = 'deepskyblue3', lwd = 2)+
  geom_point(aes(x = value.50, y = pretty_name), size = 4)+
  theme_minimal()+
  labs(x = 'Value', y = 'Parameter (Survival)')

paramvalues_s
ggsave(paramvalues_s,
       filename = here::here('04-communication',
                             'figures', 
                             'manuscript',
                             'paramvalues_s.png'),
       height = 4, width = 6.5, units = 'in')
```



## Growth


```{r}

mcmc_intervals(samples,
               pars = c('beta_g[1]',
                        'beta_g[2]',
                        'beta_g[3]',
                        'beta_g[4]',
                        'beta_g[5]',
                        'beta_g[6]',
                        'beta_g[7]',
                        'beta_g[8]',
                        'beta_g[9]',
                        'beta_g[10]',
                        'beta_g[11]',
                        'beta_g[12]',
                        'sigmaPlot_g',
                        'sigmaEco_g',
                        'sigmaEpsilon_g'))


mcmc_intervals(samples,
               pars = c('beta_g[1]',
                        'beta_g[3]',
                        'beta_g[4]',
                        'beta_g[5]',
                        'beta_g[6]',
                        'beta_g[7]',
                        'beta_g[8]',
                        'beta_g[9]',
                        'beta_g[10]',
                        'beta_g[11]',
                        'beta_g[12]',
                        'sigmaPlot_g',
                        'sigmaEco_g',
                        'sigmaEpsilon_g'))


summary_g = 
  pila_fit$summary(variables = c('beta_g', 'sigmaPlot_g', 'sigmaEco_g',
                                 'sigmaEpsilon_g')) %>%
  left_join(beta_g_names %>%
              bind_rows(
                data.frame(param = c('sigmaPlot_g', 'sigmaEco_g',
                                     'sigmaEpsilon_g'),
                       position = c('13', '14', '15'),
                       pretty_name = c('SD Plots', 'SD Ecoregions', 'SD Residual'))
              ),
            by = c('variable' = 'param')) %>%
  select(Position = position,
         Parameter = pretty_name, 
         Mean = mean, Median = median, StDev = sd, 
         q5, q95, rhat, ess_bulk, ess_tail) %>%
  arrange(Position) %>%
  select(-Position)

summary_g

write.csv(summary_g,
          here::here('04-communication',
                     'tables',
                     'summary_g.csv'),
          row.names = FALSE)

```

## Fecundity

```{r}
mcmc_intervals(samples,
               pars = c('beta_f[1]',
                        'beta_f[2]',
                        'beta_f[3]',
                        'beta_f[4]',
                        'beta_f[5]',
                        'beta_f[6]',
                        'beta_f[7]',
                        'beta_f[8]',
                        'beta_f[9]',
                        'beta_f[10]',
                        'beta_f[11]',
                        'beta_f[12]',
                        'sigmaPlot_f',
                        'sigmaEco_f'))

mcmc_intervals(samples, pars = 'kappa_r')


summary_f = 
  pila_fit$summary(variables = c('beta_f', 'sigmaPlot_f', 'sigmaEco_f', 'kappa_r')) %>%
  left_join(beta_f_names %>%
              bind_rows(
                data.frame(param = c('sigmaPlot_f', 'sigmaEco_f',
                                     'kappa_r'),
                       position = c('13', '14', '15'),
                       pretty_name = c('SD Plots', 'SD Ecoregions', 'NB Dispersion'))
              ),
            by = c('variable' = 'param')) %>%
  select(Position = position,
         Parameter = pretty_name, 
         Mean = mean, Median = median, StDev = sd, 
         q5, q95, rhat, ess_bulk, ess_tail) %>%
  arrange(Position) %>%
  select(-Position)

summary_f

write.csv(summary_f,
          here::here('04-communication',
                     'tables',
                     'summary_f.csv'),
          row.names = FALSE)

```

# Fixed Effects Counterfactuals

## Survival

```{r}

predict_survival_fixeff = 
  function(dataset){
    do.call('rbind',
            lapply(X = 1:4000,
                   FUN = function(i){
                     
                     beta_i = as.numeric(betas_s[i,])
                     
                     X = dataset[,c('intercept', 'dbh_m.init', 'fire', 
                                    'wpbr', 'ba_scaled', 
                                    'cwd_dep90_scaled', 'cwd_mean_scaled', 
                                    'dbh_fire', 'dbh_wpbr',
                                    'dbh_ba', 'dbh_cwd90', 'dbh_cwdmean')]
                     
                     predictions = X
                     predictions$logitp = 
                       as.numeric(as.matrix(X) %*% beta_i)
                     predictions$p = boot::inv.logit(predictions$logitp)
                     return(predictions)
                     
                   }))
    
  }

# first, "main effects" (other than the focal variable, disturbances held at false 
# and continuous variables held at 0 (other than size, they are scaled) 

## size main effect (no disturbances, continuous variables held at 0, which is 
## the subplot-level mean (so like the average subplot))
size_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  theme_minimal()+
  labs(y = 'Survival',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X fire
fire_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = c(0,1),
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(fire)))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975, fill = as.factor(fire)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75, fill = as.factor(fire)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  theme_minimal()+
  labs(y = 'Survival',
       fill = 'Fire',
       color = 'Fire',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X wpbr
wpbr_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = c(0,1),
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(wpbr)))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975, fill = as.factor(wpbr)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75, fill = as.factor(wpbr)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  theme_minimal()+
  labs(y = 'Survival',
       fill = 'WPBR',
       color = 'WPBR',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X Basal area
ba_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = c(-1,1),
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(ba_scaled)))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975, fill = as.factor(ba_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75, fill = as.factor(ba_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'Survival',
       fill = 'Basal Area',
       color = 'Basal Area',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X drought
drought_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = c(-1,1),
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(cwd_dep90_scaled)))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975, fill = as.factor(cwd_dep90_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75, fill = as.factor(cwd_dep90_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'Survival',
       fill = 'Drought',
       color = 'Drought',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X dryness
dryness_fixeff_s = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = c(-1,1)) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_survival_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(p.median = median(p),
            p.025 = quantile(p, probs = 0.025),
            p.25 = quantile(p, probs = 0.25),
            p.75 = quantile(p, probs = 0.75),
            p.975 = quantile(p, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(cwd_mean_scaled)))+
  geom_ribbon(aes(ymin = p.025, ymax = p.975, fill = as.factor(cwd_mean_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = p.25, ymax = p.75, fill = as.factor(cwd_mean_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = p.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'Survival',
       fill = 'Site Dryness',
       color = 'Site Dryness',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')


fixeff_s = 
  plot_grid(size_fixeff_s, fire_fixeff_s, wpbr_fixeff_s,
          ba_fixeff_s, drought_fixeff_s, dryness_fixeff_s,
          nrow = 3, ncol = 2)


fixeff_s_ppt = 
  plot_grid(
    size_fixeff_s+theme(text = element_text(size = 14)),
    fire_fixeff_s+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    wpbr_fixeff_s+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    ba_fixeff_s+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    drought_fixeff_s+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    dryness_fixeff_s+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    nrow = 2, ncol = 3
  )

fixeff_s_ppt

ggsave(fixeff_s_ppt,
       filename = here::here('04-communication',
                             'figures',
                             'powerpoint',
                             'fixeff_s.png'),
       height = 5, width = 11)

ggsave(fixeff_s,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'fixeff_s.png'), 
       height = 8, width = 6.5, units = 'in')
```

## Growth

```{r}

predict_grow_fixeff = 
  function(dataset){
    do.call('rbind',
            lapply(X = 1:4000,
                   FUN = function(i){
                     
                     beta_i = as.numeric(betas_g[i,])
                     
                     X = dataset[,c('intercept', 'dbh_m.init', 'fire', 
                                    'wpbr', 'ba_scaled', 
                                    'cwd_dep90_scaled', 'cwd_mean_scaled', 
                                    'dbh_fire', 'dbh_wpbr',
                                    'dbh_ba', 'dbh_cwd90', 'dbh_cwdmean')]
                     
                     predictions = X
                     predictions$size1 = 
                       as.numeric(as.matrix(X) %*% beta_i)
                     predictions$grow = 
                       predictions$size1-predictions$dbh_m.init
                     return(predictions)
                     
                   }))
    
  }
# first, "main effects" (other than the focal variable, disturbances held at false 
# and continuous variables held at 0 (other than size, they are scaled) 

## size main effect (no disturbances, continuous variables held at 0, which is 
## the subplot-level mean (so like the average subplot))
size_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X fire
fire_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = c(0,1),
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(fire)))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975, fill = as.factor(fire)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75, fill = as.factor(fire)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       fill = 'Fire',
       color = 'Fire',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X wpbr
wpbr_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = c(0,1),
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(wpbr)))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975, fill = as.factor(wpbr)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75, fill = as.factor(wpbr)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       fill = 'WPBR',
       color = 'WPBR',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X Basal area
ba_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = c(-1,1),
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(ba_scaled)))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975, fill = as.factor(ba_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75, fill = as.factor(ba_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       fill = 'Basal Area',
       color = 'Basal Area',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X drought
drought_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = c(-1,1),
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(cwd_dep90_scaled)))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975, fill = as.factor(cwd_dep90_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75, fill = as.factor(cwd_dep90_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       fill = 'Drought',
       color = 'Drought',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

# size X dryness
dryness_fixeff_g = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = c(-1,1)) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_grow_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(grow.median = median(grow),
            grow.025 = quantile(grow, probs = 0.025),
            grow.25 = quantile(grow, probs = 0.25),
            grow.75 = quantile(grow, probs = 0.75),
            grow.975 = quantile(grow, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(cwd_mean_scaled)))+
  geom_ribbon(aes(ymin = grow.025, ymax = grow.975, fill = as.factor(cwd_mean_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = grow.25, ymax = grow.75, fill = as.factor(cwd_mean_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = grow.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'DBH growth (m)',
       fill = 'Site Dryness',
       color = 'Site Dryness',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')

fixeff_g = 
  plot_grid(size_fixeff_g, fire_fixeff_g, wpbr_fixeff_g, ba_fixeff_g, 
            drought_fixeff_g, dryness_fixeff_g, 
            ncol = 2, nrow = 3)

fixeff_g

ggsave(fixeff_g,
       filename = here::here('04-communication',
                             'figures',
                             'manuscript',
                             'fixeff_g.png'), 
       height =8, width = 6.5, units = 'in')

fixeff_g_ppt = 
  plot_grid(
    size_fixeff_g+theme(text = element_text(size = 14)),
    fire_fixeff_g+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    wpbr_fixeff_g+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    ba_fixeff_g+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    drought_fixeff_g+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    dryness_fixeff_g+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    nrow = 2, ncol = 3
  )

fixeff_g_ppt

ggsave(fixeff_g_ppt,
       filename = here::here('04-communication',
                             'figures',
                             'powerpoint',
                             'fixeff_g.png'),
       height = 5, width = 11)
```

## Fecundity

```{r}
predict_fecundity_fixeff = 
  function(dataset){
    do.call('rbind',
            lapply(X = 1:4000,
                   FUN = function(i){
                     
                     beta_i = as.numeric(betas_f[i,])
                     
                     X = dataset[,c('intercept', 'dbh_m.init', 'fire', 
                                    'wpbr', 'ba_scaled', 
                                    'cwd_dep90_scaled', 'cwd_mean_scaled', 
                                    'dbh_fire', 'dbh_wpbr',
                                    'dbh_ba', 'dbh_cwd90', 'dbh_cwdmean')]
                     
                     predictions = X
                     predictions$logf = 
                       as.numeric(as.matrix(X) %*% beta_i)
                     predictions$fecundity = 
                       exp(predictions$logf)
                     return(predictions)
                     
                   }))
    
  }
# first, "main effects" (other than the focal variable, disturbances held at false 
# and continuous variables held at 0 (other than size, they are scaled) 

## size main effect (no disturbances, continuous variables held at 0, which is 
## the subplot-level mean (so like the average subplot))
size_fixeff_f = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_fecundity_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(fecundity.median = median(fecundity),
            fecundity.025 = quantile(fecundity, probs = 0.025),
            fecundity.25 = quantile(fecundity, probs = 0.25),
            fecundity.75 = quantile(fecundity, probs = 0.75),
            fecundity.975 = quantile(fecundity, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init))+
  geom_ribbon(aes(ymin = fecundity.025, ymax = fecundity.975),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = fecundity.25, ymax = fecundity.75),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = fecundity.median), lwd = 1.5)+
  theme_minimal()+
  labs(y = 'Fecundity',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_log10()

# size X fire
fire_fixeff_f = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = c(0,1),
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_fecundity_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(fecundity.median = median(fecundity),
            fecundity.025 = quantile(fecundity, probs = 0.025),
            fecundity.25 = quantile(fecundity, probs = 0.25),
            fecundity.75 = quantile(fecundity, probs = 0.75),
            fecundity.975 = quantile(fecundity, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(fire)))+
  geom_ribbon(aes(ymin = fecundity.025, ymax = fecundity.975, fill = as.factor(fire)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = fecundity.25, ymax = fecundity.75, fill = as.factor(fire)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = fecundity.median), lwd = 1.5)+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  theme_minimal()+
  labs(y = 'Fecundity',
       fill = 'Fire',
       color = 'Fire',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_log10()

# size X wpbr
wpbr_fixeff_f = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = c(0,1),
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_fecundity_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(fecundity.median = median(fecundity),
            fecundity.025 = quantile(fecundity, probs = 0.025),
            fecundity.25 = quantile(fecundity, probs = 0.25),
            fecundity.75 = quantile(fecundity, probs = 0.75),
            fecundity.975 = quantile(fecundity, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(wpbr)))+
  geom_ribbon(aes(ymin = fecundity.025, ymax = fecundity.975, fill = as.factor(wpbr)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = fecundity.25, ymax = fecundity.75, fill = as.factor(wpbr)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = fecundity.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Absent', 'Present'))+
  theme_minimal()+
  labs(y = 'Fecundity',
       fill = 'WPBR',
       color = 'WPBR',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_log10()

# size X Basal area
ba_fixeff_f = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = c(-1,1),
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_fecundity_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(fecundity.median = median(fecundity),
            fecundity.025 = quantile(fecundity, probs = 0.025),
            fecundity.25 = quantile(fecundity, probs = 0.25),
            fecundity.75 = quantile(fecundity, probs = 0.75),
            fecundity.975 = quantile(fecundity, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(ba_scaled)))+
  geom_ribbon(aes(ymin = fecundity.025, ymax = fecundity.975, fill = as.factor(ba_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = fecundity.25, ymax = fecundity.75, fill = as.factor(ba_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = fecundity.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'Fecundity',
       fill = 'Basal Area',
       color = 'Basal Area',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_log10()

# size X drought
drought_fixeff_f = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = c(-1,1),
            'cwd_mean_scaled' = 0) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_fecundity_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(fecundity.median = median(fecundity),
            fecundity.025 = quantile(fecundity, probs = 0.025),
            fecundity.25 = quantile(fecundity, probs = 0.25),
            fecundity.75 = quantile(fecundity, probs = 0.75),
            fecundity.975 = quantile(fecundity, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(cwd_dep90_scaled)))+
  geom_ribbon(aes(ymin = fecundity.025, ymax = fecundity.975, fill = as.factor(cwd_dep90_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = fecundity.25, ymax = fecundity.75, fill = as.factor(cwd_dep90_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = fecundity.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'Fecundity',
       fill = 'Drought',
       color = 'Drought',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_log10()

# size X dryness
dryness_fixeff_f = 
  expand.grid('intercept' = 1,
            'dbh_m.init' = seq(from = 0.1, to = 1.25, by = 0.01),
            'fire' = 0,
            'wpbr' = 0,
            'ba_scaled' = 0,
            'cwd_dep90_scaled' = 0,
            'cwd_mean_scaled' = c(-1,1)) %>%
  mutate(dbh_fire = dbh_m.init*fire,
         dbh_wpbr = dbh_m.init*wpbr,
         dbh_ba = dbh_m.init*ba_scaled,
         dbh_cwd90 = dbh_m.init*cwd_dep90_scaled,
         dbh_cwdmean = dbh_m.init*cwd_mean_scaled) %>%
  predict_fecundity_fixeff() %>%
  group_by(intercept, dbh_m.init, fire, wpbr, ba_scaled, 
           cwd_dep90_scaled, cwd_mean_scaled, dbh_fire, dbh_wpbr,
           dbh_ba, dbh_cwd90, dbh_cwdmean) %>%
  summarise(fecundity.median = median(fecundity),
            fecundity.025 = quantile(fecundity, probs = 0.025),
            fecundity.25 = quantile(fecundity, probs = 0.25),
            fecundity.75 = quantile(fecundity, probs = 0.75),
            fecundity.975 = quantile(fecundity, probs = 0.975)) %>%
  ggplot(data = .,
         aes(x = dbh_m.init, color = as.factor(cwd_mean_scaled)))+
  geom_ribbon(aes(ymin = fecundity.025, ymax = fecundity.975, fill = as.factor(cwd_mean_scaled)),
              color = NA, alpha = 0.1)+
  geom_ribbon(aes(ymin = fecundity.25, ymax = fecundity.75, fill = as.factor(cwd_mean_scaled)),
              color = NA, alpha = 0.25)+
  geom_line(aes(y = fecundity.median), lwd = 1.5)+
  #scale_y_continuous(limits = c(0, 1))+
  scale_color_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  scale_fill_viridis_d(begin = 0.05, end = 0.85, labels = c('Low', 'High'))+
  theme_minimal()+
  labs(y = 'Fecundity',
       fill = 'Site Dryness',
       color = 'Site Dryness',
       x = 'DBH (m)')+
  theme(legend.position = 'bottom')+
  scale_y_log10()

fixeff_f = 
  plot_grid(size_fixeff_f, fire_fixeff_f, wpbr_fixeff_f, ba_fixeff_f,
            drought_fixeff_f, dryness_fixeff_f,
            nrow = 3, ncol = 2)

fixeff_f

ggsave(fixeff_f,
       filename = here::here('04-communication',
                             'figures', 
                             'manuscript',
                             'fixeff_f.png'),
       height = 8, width = 6.5, units = 'in')

fixeff_f_ppt = 
  plot_grid(
    size_fixeff_f+theme(text = element_text(size = 14)),
    fire_fixeff_f+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    wpbr_fixeff_f+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    ba_fixeff_f+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    drought_fixeff_f+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    dryness_fixeff_f+theme(text = element_text(size = 14), 
                        axis.title.y = element_blank(),
                        axis.title.x = element_blank()),
    nrow = 2, ncol = 3
  )

fixeff_f_ppt

ggsave(fixeff_f_ppt,
       filename = here::here('04-communication',
                             'figures',
                             'powerpoint',
                             'fixeff_f.png'),
       height = 5, width = 11)

```

# Random Effects

```{r}
# get ecoregion polygons for mapping random effects
# (ecological subsection polygons downloaded from 
# https://data.fs.usda.gov/geodata/edw/datasets.php?dsetCategory=geoscientificinformation
# on Jan 9, 2022)
library(sf)

ecosub.sf = 
  st_read(here::here('02-data',
                     '00-source',
                     'usfs',
                     'S_USA.EcomapSubsections',
                     'S_USA.EcomapSubsections.shp')) %>%
  st_make_valid() %>%
  select(MAP_UNIT_S, MAP_UNIT_N) %>%
  left_join(
    readRDS(here::here('02-data',
                       '02-for_analysis',
                       'union_ecosubs.rds')),
    by = c('MAP_UNIT_S' = 'ecosubcd')
  )


# get plot locations for mapping random effects
plots.sf = 
  readRDS(here::here('02-data',
                     '02-for_analysis',
                     'union_plots.rds')) %>%
  
  left_join(
    readRDS(here::here('02-data',
                       '01-preprocessed',
                       'plot_data.rds')) %>%
      group_by(plot_id, lat, lon) %>%
      summarise() %>%
      ungroup()
  ) %>%
  st_as_sf(coords = c('lon', 'lat'),
           crs = 4269)



```


## Survival

```{r}
ecoEffect_s.med = 
  samples %>%
  select(contains('ecoEffect_s')) %>%
  summarise_all(median) %>%
  as.numeric()

ecosub.sf$ecoEffect_s.med = 
  ecoEffect_s.med[ecosub.sf$ecosub.i]

ecoEffect_map_s = 
  ggplot(data = ecosub.sf,
       aes(fill = ecoEffect_s.med))+
  geom_sf(data = 
            USAboundaries::us_states(),
          fill = NA)+
  geom_sf(color = NA)+
  theme_minimal()+
  scale_fill_viridis_c(na.value = 'transparent')+
  labs(fill = 'Ecoregion effect\n(Survival)')+
  theme(legend.position = 'bottom')+
  coord_sf(xlim = c(390000, 1100000), ylim = c(3740000, 5020000),
           crs = "EPSG:26910")+
  annotation_scale()

ecoEffect_map_s

plotEffect_s.med = 
  samples %>%
  select(contains('plotEffect_s')) %>%
  summarise_all(median) %>%
  as.numeric()

plots.sf$plotEffect_s.med = 
  plotEffect_s.med[plots.sf$plot_id.i]

ggplot(data = plots.sf,
       aes(color = plotEffect_s.med))+
  geom_sf(size = 1, alpha = 0.5)+
  theme_minimal()+
  scale_color_viridis_c()

```


## Growth


```{r}
ecoEffect_g.med = 
  samples %>%
  select(contains('ecoEffect_g')) %>%
  summarise_all(median) %>%
  as.numeric()

ecosub.sf$ecoEffect_g.med = 
  ecoEffect_g.med[ecosub.sf$ecosub.i]

ecoEffect_map_g = 
  ggplot(data = ecosub.sf,
       aes(fill = ecoEffect_g.med))+
  geom_sf(data = 
            USAboundaries::us_states(),
          fill = NA)+
  geom_sf(color = NA)+
  theme_minimal()+
  scale_fill_viridis_c(na.value = 'transparent')+
  labs(fill = 'Ecoregion effect\n(Growth)')+
  theme(legend.position = 'bottom')+
  coord_sf(xlim = c(390000, 1100000), ylim = c(3740000, 5020000),
           crs = "EPSG:26910")+
  annotation_scale()

ecoEffect_map_g

plotEffect_g.med = 
  samples %>%
  select(contains('plotEffect_g')) %>%
  summarise_all(median) %>%
  as.numeric()

plots.sf$plotEffect_g.med = 
  plotEffect_g.med[plots.sf$plot_id.i]

ggplot(data = plots.sf,
       aes(color = plotEffect_g.med))+
  geom_sf(size = 1, alpha = 0.5)+
  theme_minimal()+
  scale_color_viridis_c()

```

Ecoregion-level effects don't look independent here; there's a clear pattern 
of higher growth in the SE part of the range and lower growth in the NW.

## Fecundity


```{r}
ecoEffect_f.med = 
  samples %>%
  select(contains('ecoEffect_f')) %>%
  summarise_all(median) %>%
  as.numeric()

ecosub.sf$ecoEffect_f.med = 
  ecoEffect_f.med[ecosub.sf$ecosub.i]

ecoEffect_map_f = 
  ggplot(data = ecosub.sf,
       aes(fill = ecoEffect_f.med))+
  geom_sf(data = 
            USAboundaries::us_states(),
          fill = NA)+
  geom_sf(color = NA)+
  theme_minimal()+
  scale_fill_viridis_c(na.value = 'transparent')+
  labs(fill = 'Ecoregion effect\n(Fecundity)')+
  theme(legend.position = 'bottom')+
  coord_sf(xlim = c(390000, 1100000), ylim = c(3740000, 5020000),
           crs = "EPSG:26910")+
  annotation_scale()

ecoEffect_map_f

plotEffect_f.med = 
  samples %>%
  select(contains('plotEffect_f')) %>%
  summarise_all(median) %>%
  as.numeric()

plots.sf$plotEffect_f.med = 
  plotEffect_f.med[plots.sf$plot_id.i]

ggplot(data = plots.sf,
       aes(color = plotEffect_f.med))+
  geom_sf(size = 1, alpha = 0.5)+
  theme_minimal()+
  scale_color_viridis_c()

```

## Ecoregion effect map for all three

```{r}
ecoEffect_map = 
  plot_grid(ecoEffect_map_s, ecoEffect_map_g, ecoEffect_map_f,
            nrow = 1)

ecoEffect_map

ggsave(ecoEffect_map,
       filename = here::here('04-communication',
                  'figures',
                  'manuscript',
                  'ecoEffect_map.png'),
       height = 6.5, width = 8.5, units = 'in')

```


# Data slide

A map with all the data sources on it:

```{r}

overview_map = 
  ggplot(data = 
         spData::world %>%
         filter(continent=='North America'))+
  geom_sf(fill = NA, lwd = 1)+
  geom_rect(xmin = 390000, xmax = 1100000, ymin = 3740000, ymax = 5020000,
            fill = NA, color = 'red', lwd = 2)+
  coord_sf(crs = "EPSG:26910",
           xlim = c(200000, 5000000), ylim = c(1000000, 8000000))+
  theme_minimal()+
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        panel.grid = element_blank(),
        plot.background = element_rect(fill = 'white'),
        plot.margin = unit(c(0, 0, 0, 0), 'cm'))

overview_map

range_map = 
  ggplot()+
  geom_sf(data = 
            spData::us_states,
          fill = NA, lwd = 1)+
  #geom_sf(color = 'blue', fill = NA)+
  geom_sf(data = plots.sf, aes(color = 'red'), size = 1, alpha = 0.5)+
  theme_minimal()+
  coord_sf(xlim = c(390000, 1100000), ylim = c(3740000, 5020000),
           crs = "EPSG:26910")+
  annotation_scale()+
  scale_color_manual(name = '', 
                     values = c('red' = 'red'), 
                     labels = c('FIA plots'))+
  theme(legend.position = 'bottom',
        text = element_text(size = 18),
        axis.text.x = element_blank(),
        axis.text.y = element_blank())

range_map


data_map = 
  ggdraw()+
  draw_plot(range_map)+
  draw_plot(overview_map,
            x = 0.48, y = 0.6, width = 0.3, height = 0.3)

data_map

ggsave(data_map,
       filename = here::here('04-communication',
                             'figures',
                             'powerpoint',
                             'data_map.png'),
       height = 6, width = 4, units = 'in')

```